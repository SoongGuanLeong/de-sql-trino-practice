## Find Top 3 Commonly Bought Product Pairs
 
Using the table playground.product_transactions, write a query to find the top 3 pairs of products that are most frequently bought together in the same transaction from the table playground.product_transactions. For this analysis, consider a pair to consist of two different products purchased in the same transaction. The output should list the pairs of products and the frequency of each pair (product1, product2, freq), ordered by product1 in ascending order, product2 in ascending order and frequency in descending order.

### These are the tables to query for this question:
**playground.product_transactions**
- transaction_id int
- product_name string
### Your answer should include these columns:
- product1 varchar
- product2 varchar
- freq integer

## Answer
```sql
WITH A AS (
  SELECT * FROM playground.product_transactions
), 
B AS (
  SELECT 
  COALESCE(a1.transaction_id, a2.transaction_id) AS transaction_id,
    a1.product_name AS product1,
    a2.product_name AS product2
  FROM A a1 JOIN A a2
  ON a1.transaction_id = a2.transaction_id
  AND a1.product_name < a2.product_name
), 
C AS (
  SELECT product1, product2,
    COUNT(1) AS freq,
    row_number() OVER (ORDER BY COUNT(1) DESC) AS row_num
  FROM B
  GROUP BY 1, 2
  ORDER BY 3 DESC
), 
D AS (
  SELECT freq, MAX(row_num) AS desired_rank FROM C
  GROUP BY freq
)
SELECT product1, product2, C.freq AS freq
FROM C JOIN D ON C.freq = D.freq
WHERE desired_rank <= 3
ORDER BY 1, 2, 3 DESC
```

## Results
| product1 | product2 | freq |
|----------|----------|------|
| Pen      | Pencil   | 3    |